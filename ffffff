import os
import json
import datetime
from telebot import TeleBot, types
from telebot.util import quick_markup

# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
BOT_TOKEN = "8354515031:AAEnTTa0qdU8teKjwMv373llShkM4alH62Q"
ADMIN_GROUP_ID = -5026479411
CHANNEL_ID = -1002658375841
POSTS_FILE = "posts.json"

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
bot = TeleBot(BOT_TOKEN)

# –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ JSON
def load_posts():
    if os.path.exists(POSTS_FILE):
        with open(POSTS_FILE, 'r', encoding='utf-8') as f:
            data = json.load(f)
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö –∏ –∏—Å–ø—Ä–∞–≤–ª—è–µ–º –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            if isinstance(data, list):
                # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Å—Ç–∞—Ä—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –≤ –Ω–æ–≤—É—é
                data = {"posts": {}, "user_states": {}}
                save_posts(data)
            return data
    return {"posts": {}, "user_states": {}}

# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ JSON
def save_posts(data):
    with open(POSTS_FILE, 'w', encoding='utf-8') as f:
        json.dump(data, f, ensure_ascii=False, indent=2)

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID –ø–æ—Å—Ç–∞
def generate_post_id():
    data = load_posts()
    if not data["posts"]:
        return 1
    return max([int(i) for i in data["posts"].keys()]) + 1

# –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
def main_menu():
    return quick_markup({
        'üìù –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ—Å—Ç': {'callback_data': 'send_post'},
        'üìÇ –ú–æ–∏ –ø–æ—Å—Ç—ã': {'callback_data': 'my_posts'}
    }, row_width=1)

# –ú–µ–Ω—é –ø–æ—Å–ª–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
def after_publish_menu():
    return quick_markup({
        'üìù –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –ø–æ—Å—Ç': {'callback_data': 'send_post'},
        'üìÇ –ú–æ–∏ –ø–æ—Å—Ç—ã': {'callback_data': 'my_posts'}
    }, row_width=1)

# –ö–Ω–æ–ø–∫–∏ –º–æ–¥–µ—Ä–∞—Ü–∏–∏
def moderation_buttons(post_id):
    return quick_markup({
        '‚úÖ –ü—Ä–∏–Ω—è—Ç—å': {'callback_data': f'approve_{post_id}'},
        '‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å': {'callback_data': f'reject_{post_id}'},
        'üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å': {'callback_data': f'ban_{post_id}'}
    }, row_width=2)

# –ö–Ω–æ–ø–∫–∏ –º–æ–¥–µ—Ä–∞—Ü–∏–∏ —Å —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π
def moderation_buttons_unban(post_id):
    return quick_markup({
        '‚úÖ –ü—Ä–∏–Ω—è—Ç—å': {'callback_data': f'approve_{post_id}'},
        '‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å': {'callback_data': f'reject_{post_id}'},
        '‚úÖ –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å': {'callback_data': f'unban_{post_id}'}
    }, row_width=2)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
@bot.message_handler(commands=['start'])
def start_command(message):
    bot.send_message(
        message.chat.id,
        "üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –±–æ—Ç-–ø—Ä–µ–¥–ª–æ–∂–∫—É!\n\n"
        "–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ø–æ—Å—Ç –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ –∫–∞–Ω–∞–ª–µ.",
        reply_markup=main_menu()
    )

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /post{id}
@bot.message_handler(regexp=r'^/post\d+$')
def show_post(message):
    data = load_posts()
    post_id = message.text.replace('/post', '')
    
    if post_id not in data["posts"]:
        bot.send_message(message.chat.id, "‚ùå –ü–æ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        return
    
    post = data["posts"][post_id]
    
    if str(post["user_id"]) != str(message.from_user.id):
        bot.send_message(message.chat.id, "‚ùå –≠—Ç–æ –Ω–µ –≤–∞—à –ø–æ—Å—Ç.")
        return
    
    # –û—Ç–ø—Ä–∞–≤–∫–∞ –º–µ–¥–∏–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
    if post["media_type"] == "text":
        bot.send_message(message.chat.id, f"üìù –¢–µ–∫—Å—Ç –ø–æ—Å—Ç–∞:\n\n{post['text']}")
    
    elif post["media_type"] == "photo":
        bot.send_photo(message.chat.id, post["file_id"], caption=post["text"])
    
    elif post["media_type"] == "video":
        bot.send_video(message.chat.id, post["file_id"], caption=post["text"])
    
    elif post["media_type"] == "sticker":
        bot.send_sticker(message.chat.id, post["file_id"])
        if post["text"]:
            bot.send_message(message.chat.id, f"üìù –ü–æ–¥–ø–∏—Å—å:\n\n{post['text']}")
    
    elif post["media_type"] == "voice":
        bot.send_voice(message.chat.id, post["file_id"], caption=post["text"])
    
    elif post["media_type"] == "video_note":
        bot.send_video_note(message.chat.id, post["file_id"])
        if post["text"]:
            bot.send_message(message.chat.id, f"üìù –ü–æ–¥–ø–∏—Å—å:\n\n{post['text']}")
    
    elif post["media_type"] == "media_group":
        if post["text"]:
            bot.send_message(message.chat.id, f"üìù –ü–æ–¥–ø–∏—Å—å –∞–ª—å–±–æ–º–∞:\n\n{post['text']}")
        else:
            bot.send_message(message.chat.id, "üì∑ –ú–µ–¥–∏–∞-–∞–ª—å–±–æ–º (–±–µ–∑ –ø–æ–¥–ø–∏—Å–∏)")

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ callback-–∑–∞–ø—Ä–æ—Å–æ–≤
@bot.callback_query_handler(func=lambda call: True)
def callback_handler(call):
    data = load_posts()
    user_id = call.from_user.id
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö
    if "user_states" not in data:
        data["user_states"] = {}
    if "posts" not in data:
        data["posts"] = {}
    
    if call.data == 'send_post':
        if str(user_id) in data.get("user_states", {}) and data["user_states"].get(str(user_id)) == "banned":
            bot.answer_callback_query(call.id, "‚ùå –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ø–æ—Å—Ç—ã.")
            return
        
        bot.send_message(
            call.message.chat.id,
            "üì§ –û—Ç–ø—Ä–∞–≤—å—Ç–µ –≤–∞—à –ø–æ—Å—Ç (—Ç–µ–∫—Å—Ç, —Ñ–æ—Ç–æ, –≤–∏–¥–µ–æ, —Å—Ç–∏–∫–µ—Ä, –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –≤–∏–¥–µ–æ-–∑–∞–º–µ—Ç–∫—É):"
        )
        bot.answer_callback_query(call.id)
    
    elif call.data == 'my_posts':
        user_posts = []
        for post_id, post in data["posts"].items():
            if str(post["user_id"]) == str(user_id):
                status_emoji = {
                    "approved": "‚úÖ",
                    "rejected": "‚ùå", 
                    "pending": "‚è≥"
                }.get(post["status"], "‚è≥")
                
                date = post.get("date", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")
                user_posts.append(f"üÜî /post{post_id} ‚Äî {status_emoji} {post['status']} ({date})")
        
        if user_posts:
            bot.edit_message_text(
                "\n".join(user_posts),
                call.message.chat.id,
                call.message.message_id,
                reply_markup=quick_markup({'üîô –ù–∞–∑–∞–¥': {'callback_data': 'back_to_main'}})
            )
        else:
            bot.edit_message_text(
                "üì≠ –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø–æ—Å—Ç–æ–≤.",
                call.message.chat.id,
                call.message.message_id,
                reply_markup=quick_markup({'üîô –ù–∞–∑–∞–¥': {'callback_data': 'back_to_main'}})
            )
        bot.answer_callback_query(call.id)
    
    elif call.data == 'back_to_main':
        bot.edit_message_text(
            "üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –±–æ—Ç-–ø—Ä–µ–¥–ª–æ–∂–∫—É!\n\n"
            "–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ø–æ—Å—Ç –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ –∫–∞–Ω–∞–ª–µ.",
            call.message.chat.id,
            call.message.message_id,
            reply_markup=main_menu()
        )
        bot.answer_callback_query(call.id)
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏
    elif call.data.startswith(('approve_', 'reject_', 'ban_', 'unban_')):
        if call.message.chat.id != ADMIN_GROUP_ID:
            bot.answer_callback_query(call.id, "‚ùå –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º.")
            return
        
        action, post_id = call.data.split('_', 1)
        post = data["posts"].get(post_id)
        
        if not post:
            bot.answer_callback_query(call.id, "‚ùå –ü–æ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.")
            return
        
        admin_username = f"@{call.from_user.username}" if call.from_user.username else call.from_user.first_name
        
        if action == 'approve':
            # –ü—É–±–ª–∏–∫–∞—Ü–∏—è –ø–æ—Å—Ç–∞ –≤ –∫–∞–Ω–∞–ª
            try:
                if post["media_type"] == "text":
                    bot.send_message(CHANNEL_ID, post["text"])
                elif post["media_type"] == "photo":
                    bot.send_photo(CHANNEL_ID, post["file_id"], caption=post["text"])
                elif post["media_type"] == "video":
                    bot.send_video(CHANNEL_ID, post["file_id"], caption=post["text"])
                elif post["media_type"] == "sticker":
                    bot.send_sticker(CHANNEL_ID, post["file_id"])
                elif post["media_type"] == "voice":
                    bot.send_voice(CHANNEL_ID, post["file_id"], caption=post["text"])
                elif post["media_type"] == "video_note":
                    bot.send_video_note(CHANNEL_ID, post["file_id"])
                elif post["media_type"] == "media_group":
                    if post["text"]:
                        bot.send_message(CHANNEL_ID, post["text"])
                
                post["status"] = "approved"
                post["moderated_by"] = admin_username
                
                # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                try:
                    bot.send_message(
                        post["user_id"],
                        "üéâ –í–∞—à –ø–æ—Å—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!\n–•–æ—Ç–∏—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π?",
                        reply_markup=after_publish_menu()
                    )
                except:
                    pass  # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–≥ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –±–æ—Ç–∞
                
            except Exception as e:
                bot.answer_callback_query(call.id, f"‚ùå –û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏: {e}")
                return
        
        elif action == 'reject':
            post["status"] = "rejected"
            post["moderated_by"] = admin_username
            
            # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            try:
                bot.send_message(post["user_id"], "üòï –í–∞—à –ø–æ—Å—Ç –±—ã–ª –æ—Ç–∫–ª–æ–Ω—ë–Ω.")
            except:
                pass  # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–≥ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –±–æ—Ç–∞
        
        elif action == 'ban':
            data["user_states"][str(post["user_id"])] = "banned"
            # –ó–∞–º–µ–Ω–∞ –∫–Ω–æ–ø–∫–∏ –Ω–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫—É
            try:
                bot.edit_message_reply_markup(
                    ADMIN_GROUP_ID,
                    call.message.message_id,
                    reply_markup=moderation_buttons_unban(post_id)
                )
            except:
                pass
            bot.answer_callback_query(call.id, "‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω")
        
        elif action == 'unban':
            if str(post["user_id"]) in data["user_states"]:
                del data["user_states"][str(post["user_id"])]
            # –ó–∞–º–µ–Ω–∞ –∫–Ω–æ–ø–∫–∏ –Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
            try:
                bot.edit_message_reply_markup(
                    ADMIN_GROUP_ID,
                    call.message.message_id,
                    reply_markup=moderation_buttons(post_id)
                )
            except:
                pass
            bot.answer_callback_query(call.id, "‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω")
        
        # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –≥—Ä—É–ø–ø–µ –º–æ–¥–µ—Ä–∞—Ü–∏–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        if action in ['approve', 'reject']:
            try:
                # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
                current_text = call.message.text or call.message.caption or ""
                
                status_text = {
                    'approve': f"‚úÖ –ü—Ä–∏–Ω—è—Ç–æ {admin_username}",
                    'reject': f"‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ {admin_username}"
                }.get(action, "")
                
                new_text = f"{current_text}\n\n{status_text}"
                
                # –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
                if call.message.text:  # –¢–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    bot.edit_message_text(
                        new_text,
                        ADMIN_GROUP_ID,
                        call.message.message_id,
                        reply_markup=None
                    )
                elif call.message.caption:  # –°–æ–æ–±—â–µ–Ω–∏–µ —Å –º–µ–¥–∏–∞
                    bot.edit_message_caption(
                        new_text,
                        ADMIN_GROUP_ID,
                        call.message.message_id,
                        reply_markup=None
                    )
            except Exception as e:
                print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
                # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å, –ø—Ä–æ—Å—Ç–æ —É–±–∏—Ä–∞–µ–º –∫–Ω–æ–ø–∫–∏
                try:
                    bot.edit_message_reply_markup(
                        ADMIN_GROUP_ID,
                        call.message.message_id,
                        reply_markup=None
                    )
                except:
                    pass
        
        save_posts(data)
        if action not in ['ban', 'unban']:
            bot.answer_callback_query(call.id, "‚úÖ –î–µ–π—Å—Ç–≤–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ")

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
@bot.message_handler(content_types=['text'])
def handle_text(message):
    data = load_posts()
    user_id = message.from_user.id
    
    if str(user_id) in data.get("user_states", {}) and data["user_states"].get(str(user_id)) == "banned":
        bot.send_message(message.chat.id, "‚ùå –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ø–æ—Å—Ç—ã.")
        return
    
    post_id = generate_post_id()
    username = f"@{message.from_user.username}" if message.from_user.username else message.from_user.first_name
    
    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Å—Ç–∞
    data["posts"][str(post_id)] = {
        "user_id": user_id,
        "username": username,
        "text": message.text,
        "media_type": "text",
        "file_id": None,
        "status": "pending",
        "date": datetime.datetime.now().strftime("%d.%m.%Y %H:%M")
    }
    
    # –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –≥—Ä—É–ø–ø—É –º–æ–¥–µ—Ä–∞—Ü–∏–∏
    admin_message = bot.send_message(
        ADMIN_GROUP_ID,
        f"üë§ {username} (ID {user_id}) –ø—Ä–µ–¥–ª–æ–∂–∏–ª –ø–æ—Å—Ç #{post_id}\n\n{message.text}",
        reply_markup=moderation_buttons(post_id)
    )
    
    data["posts"][str(post_id)]["admin_message_id"] = admin_message.message_id
    save_posts(data)
    
    bot.send_message(
        message.chat.id,
        "‚úÖ –ü–æ—Å—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é!",
        reply_markup=main_menu()
    )

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ç–æ
@bot.message_handler(content_types=['photo'])
def handle_photo(message):
    process_media(message, 'photo')

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–∏–¥–µ–æ
@bot.message_handler(content_types=['video'])
def handle_video(message):
    process_media(message, 'video')

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å—Ç–∏–∫–µ—Ä–æ–≤
@bot.message_handler(content_types=['sticker'])
def handle_sticker(message):
    process_media(message, 'sticker')

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
@bot.message_handler(content_types=['voice'])
def handle_voice(message):
    process_media(message, 'voice')

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–∏–¥–µ–æ-–∑–∞–º–µ—Ç–æ–∫
@bot.message_handler(content_types=['video_note'])
def handle_video_note(message):
    process_media(message, 'video_note')

# –û–±—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –º–µ–¥–∏–∞
def process_media(message, media_type):
    data = load_posts()
    user_id = message.from_user.id
    
    if str(user_id) in data.get("user_states", {}) and data["user_states"].get(str(user_id)) == "banned":
        bot.send_message(message.chat.id, "‚ùå –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ø–æ—Å—Ç—ã.")
        return
    
    post_id = generate_post_id()
    username = f"@{message.from_user.username}" if message.from_user.username else message.from_user.first_name
    
    # –ü–æ–ª—É—á–µ–Ω–∏–µ file_id –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –º–µ–¥–∏–∞
    file_id = None
    if media_type == 'photo':
        file_id = message.photo[-1].file_id
    elif media_type == 'video':
        file_id = message.video.file_id
    elif media_type == 'sticker':
        file_id = message.sticker.file_id
    elif media_type == 'voice':
        file_id = message.voice.file_id
    elif media_type == 'video_note':
        file_id = message.video_note.file_id
    
    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Å—Ç–∞
    data["posts"][str(post_id)] = {
        "user_id": user_id,
        "username": username,
        "text": message.caption or "",
        "media_type": media_type,
        "file_id": file_id,
        "status": "pending",
        "date": datetime.datetime.now().strftime("%d.%m.%Y %H:%M")
    }
    
    # –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –≥—Ä—É–ø–ø—É –º–æ–¥–µ—Ä–∞—Ü–∏–∏
    media_names = {
        'photo': '—Ñ–æ—Ç–æ',
        'video': '–≤–∏–¥–µ–æ', 
        'sticker': '—Å—Ç–∏–∫–µ—Ä',
        'voice': '–≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ',
        'video_note': '–≤–∏–¥–µ–æ-–∑–∞–º–µ—Ç–∫–∞'
    }
    
    caption_text = f"\n\n{message.caption}" if message.caption else ""
    admin_text = f"üë§ {username} (ID {user_id}) –ø—Ä–µ–¥–ª–æ–∂–∏–ª –ø–æ—Å—Ç #{post_id} ({media_names[media_type]}){caption_text}"
    
    # –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ —Ç–∏–ø–∞ –º–µ–¥–∏–∞ –≤ –≥—Ä—É–ø–ø—É –º–æ–¥–µ—Ä–∞—Ü–∏–∏
    try:
        if media_type == 'photo':
            admin_message = bot.send_photo(ADMIN_GROUP_ID, file_id, caption=admin_text, reply_markup=moderation_buttons(post_id))
        elif media_type == 'video':
            admin_message = bot.send_video(ADMIN_GROUP_ID, file_id, caption=admin_text, reply_markup=moderation_buttons(post_id))
        elif media_type == 'sticker':
            msg1 = bot.send_sticker(ADMIN_GROUP_ID, file_id)
            admin_message = bot.send_message(ADMIN_GROUP_ID, admin_text, reply_markup=moderation_buttons(post_id))
        elif media_type == 'voice':
            admin_message = bot.send_voice(ADMIN_GROUP_ID, file_id, caption=admin_text, reply_markup=moderation_buttons(post_id))
        elif media_type == 'video_note':
            msg1 = bot.send_video_note(ADMIN_GROUP_ID, file_id)
            admin_message = bot.send_message(ADMIN_GROUP_ID, admin_text, reply_markup=moderation_buttons(post_id))
    except Exception as e:
        # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å –º–µ–¥–∏–∞, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        admin_message = bot.send_message(ADMIN_GROUP_ID, admin_text, reply_markup=moderation_buttons(post_id))
    
    data["posts"][str(post_id)]["admin_message_id"] = admin_message.message_id
    save_posts(data)
    
    bot.send_message(
        message.chat.id,
        f"‚úÖ {media_names[media_type].capitalize()} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é!",
        reply_markup=main_menu()
    )

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –º–µ–¥–∏–∞-–≥—Ä—É–ø–ø (–∞–ª—å–±–æ–º–æ–≤)
@bot.message_handler(content_types=['media_group'])
def handle_media_group(message):
    data = load_posts()
    user_id = message.from_user.id
    
    if str(user_id) in data.get("user_states", {}) and data["user_states"].get(str(user_id)) == "banned":
        bot.send_message(message.chat.id, "‚ùå –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ø–æ—Å—Ç—ã.")
        return
    
    # –î–ª—è –º–µ–¥–∏–∞-–≥—Ä—É–ø–ø –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    if message.media_group_id:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∏ –ª–∏ –º—ã —É–∂–µ —ç—Ç—É –≥—Ä—É–ø–ø—É
        for post in data["posts"].values():
            if post.get("media_group_id") == message.media_group_id:
                return
    
    post_id = generate_post_id()
    username = f"@{message.from_user.username}" if message.from_user.username else message.from_user.first_name
    
    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Å—Ç–∞
    data["posts"][str(post_id)] = {
        "user_id": user_id,
        "username": username,
        "text": message.caption or "",
        "media_type": "media_group",
        "file_id": None,
        "media_group_id": message.media_group_id,
        "status": "pending",
        "date": datetime.datetime.now().strftime("%d.%m.%Y %H:%M")
    }
    
    # –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –≥—Ä—É–ø–ø—É –º–æ–¥–µ—Ä–∞—Ü–∏–∏
    caption_text = f"\n\n{message.caption}" if message.caption else ""
    admin_message = bot.send_message(
        ADMIN_GROUP_ID,
        f"üë§ {username} (ID {user_id}) –ø—Ä–µ–¥–ª–æ–∂–∏–ª –ø–æ—Å—Ç #{post_id} (–º–µ–¥–∏–∞-–∞–ª—å–±–æ–º){caption_text}",
        reply_markup=moderation_buttons(post_id)
    )
    
    data["posts"][str(post_id)]["admin_message_id"] = admin_message.message_id
    save_posts(data)
    
    bot.send_message(
        message.chat.id,
        "‚úÖ –ú–µ–¥–∏–∞-–∞–ª—å–±–æ–º –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é!",
        reply_markup=main_menu()
    )

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
if __name__ == "__main__":
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
    bot.infinity_polling()
